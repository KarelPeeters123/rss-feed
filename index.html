<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My RSS & Atom Feed Aggregator</title>
  <style>
    body { font-family: Arial, sans-serif; background:#fafafa; color:#333; max-width:800px; margin:40px auto; padding:0 20px; }
    h1 { text-align:center; }
    nav { display:flex; justify-content:center; margin-bottom:20px; }
    .tab-button { background:#eee; border:none; padding:10px 20px; cursor:pointer; margin:0 5px; border-radius:6px; font-size:1rem; transition:background .3s; }
    .tab-button.active { background:#0066cc; color:white; }

    .feed-item { border-bottom:1px solid #ddd; padding:10px 0; }
    .feed-item h2 { font-size:1.1rem; margin:0; }
    .feed-item a { color:#0066cc; text-decoration:none; }
    .feed-item a:hover { text-decoration:underline; }
    .source { color:#777; font-size:.9rem; }
    small { color:#999; font-size:.85rem; }

    /* Loading styles */
    .loading { text-align:center; padding:40px; font-size:1.2rem; color:#666; }
    .spinner { display:inline-block; width:24px; height:24px; border:3px solid #ccc; border-top-color:#0066cc; border-radius:50%; animation:spin 1s linear infinite; vertical-align:middle; margin-right:8px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Progress bar */
    .progress-container { width:60%; margin:16px auto 0; background:#eee; border-radius:8px; height:10px; overflow:hidden; }
    .progress-bar { height:100%; width:0%; background:#0066cc; transition:width 0.3s; }
  </style>
</head>
<body>
  <h1>My RSS & Atom Feed Aggregator</h1>

  <nav>
    <button class="tab-button active">Feeds</button>
    <a href="youtube.html"><button class="tab-button">YouTube</button></a>
  </nav>

  <div id="rss-loading" class="loading">
    <span class="spinner"></span> Loading RSS feeds...
    <div class="progress-container"><div class="progress-bar" id="rss-progress"></div></div>
  </div>
  <div id="rss"></div>

  <script src="shared.js"></script>
  <script>
    const feeds = [
      "https://www.rnz.co.nz/rss/national.xml",
      "https://www.stuff.co.nz/rss",
      "https://www.nzherald.co.nz/arc/outboundfeeds/rss/curated/78/?outputType=xml&_website=nzh"
    ];

    async function loadRSSFeeds() {
      const feedContainer = document.getElementById("rss");
      const loading = document.getElementById("rss-loading");
      const progressBar = document.getElementById("rss-progress");
      loading.style.display = "block";
      feedContainer.innerHTML = '';

      const allItems = [];
      let completed = 0;

      for (const url of feeds) {
        try {
          const xml = await fetchFeed(url);
          const isRSS = xml.querySelector("rss, channel");
          const isAtom = xml.querySelector("feed");
          let sourceTitle = url;
          let items = [];
          if (isRSS) {
            sourceTitle = xml.querySelector("channel > title")?.textContent || url;
            items = Array.from(xml.querySelectorAll("item")).map(item => ({
              title: item.querySelector("title")?.textContent || "No title",
              link: item.querySelector("link")?.textContent || "#",
              description: item.querySelector("description")?.textContent || "",
              pubDate: item.querySelector("pubDate")?.textContent || "",
              source: sourceTitle,
            }));
          } else if (isAtom) {
            sourceTitle = xml.querySelector("feed > title")?.textContent || url;
            items = Array.from(xml.querySelectorAll("entry")).map(entry => ({
              title: entry.querySelector("title")?.textContent || "No title",
              link: entry.querySelector("link")?.getAttribute("href") || "#",
              description: entry.querySelector("summary")?.textContent ||
                entry.querySelector("content")?.textContent || "",
              pubDate: entry.querySelector("updated")?.textContent ||
                entry.querySelector("published")?.textContent || "",
              source: sourceTitle,
            }));
          }

          items.forEach(item => {
            const date = new Date(item.pubDate);
            allItems.push({ ...item, date });
          });
        } catch (err) {
          console.error("Failed to load feed:", url, err);
        }

        completed++;
        progressBar.style.width = `${(completed / feeds.length) * 100}%`;
      }

      // Sort and render
      allItems.sort((a, b) => b.date - a.date);
      allItems.forEach(item => {
        const div = document.createElement("div");
        div.className = "feed-item";
        const formattedDate = formatDate(item.date);
        div.innerHTML = `
          <h2><a href="${item.link}" target="_blank" rel="noopener">${item.title}</a></h2>
          <div class="source">Source: ${item.source}</div>
          <div>${item.description}</div>
          ${formattedDate ? `<small>${formattedDate}</small>` : ""}
        `;
        feedContainer.appendChild(div);
      });

      loading.style.display = "none";
    }

    loadRSSFeeds();
  </script>
</body>
</html>
